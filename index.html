<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>UX-—Ç–µ—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f5f5f5}
header{background:#2f2f2f;color:#fff;padding:14px 16px;font-size:18px}
.controls{background:#fff;padding:10px 16px;border-bottom:1px solid #ddd;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.container{padding:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.item{background:#fff;border-radius:10px;padding:16px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.08)}
.folder{cursor:pointer;background:#f0f8ff;font-weight:bold}
.product{background:#fffbe6;cursor:pointer}
.path{padding:10px 16px;background:#fafafa;border-bottom:1px solid #ddd}
.path span{color:#0077cc;cursor:pointer}
button,input{padding:6px 10px}
.test-box{padding:12px 16px;background:#e8f4ff;border-bottom:1px solid #cce}
.alert-wrong{background:#ffe8e8;color:#a00;padding:10px 16px}
</style>
</head>

<body>

<header>UX-—Ç–µ—Å—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞</header>

<div class="controls">
  <input type="text" id="employeeName" placeholder="–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
  <input type="file" id="fileInput" accept=".xlsx,.xls">
  <button onclick="goBack()">–ù–∞–∑–∞–¥</button>
  <button onclick="goHome()">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
  <button onclick="startSmartTest()">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
  <button onclick="exportResults()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
</div>

<div class="test-box" id="testBox" style="display:none"></div>
<div class="alert-wrong" id="wrongBox" style="display:none">‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>
<div class="path" id="path">üìÅ</div>
<div class="container" id="container"></div>

<script>
/* ========= –•–†–ê–ù–ò–õ–ò–©–ï ========= */
const STORAGE_KEY = 'ux_test_history';
let testHistory = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

/* ========= –î–ê–ù–ù–´–ï ========= */
let tree = {};
let currentPath = [];
let employee = '';

let testItems = [];
let testIndex = 0;
let testClicks = 0;
let activeTarget = null;

/* ========= –ó–ê–ì–†–£–ó–ö–ê EXCEL ========= */
document.getElementById('fileInput').addEventListener('change', loadExcel);

function loadExcel(e){
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=ev=>{
    const wb=XLSX.read(ev.target.result,{type:'binary'});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});

    tree={};
    const stack=[];

    rows.slice(1).forEach(r=>{
      const level=Number(r[0]);
      const type=r[1];
      const name=r[2];
      if(!level||!type||!name) return;

      const node={name,type,children:{}};
      stack[level-1]=node;
      stack.length=level;

      if(level===1) tree[name]=node;
      else if(stack[level-2]?.type==='folder'){
        stack[level-2].children[name]=node;
      }
    });

    currentPath=[];
    render();
  };
  reader.readAsBinaryString(file);
}

/* ========= –ù–ê–í–ò–ì–ê–¶–ò–Ø ========= */
function getNode(){
  return currentPath.reduce((n,k)=>n.children[k],{children:tree});
}

function render(){
  const c=document.getElementById('container');
  const p=document.getElementById('path');
  c.innerHTML='';
  p.innerHTML='üìÅ '+currentPath.map((x,i)=>`<span onclick="goTo(${i})">${x}</span>`).join(' / ');

  Object.values(getNode().children).forEach(ch=>{
    const d=document.createElement('div');
    d.className='item '+(ch.type==='folder'?'folder':'product');
    d.textContent=ch.type==='folder'?'üìÅ '+ch.name:ch.name;

    if(ch.type==='folder'){
      d.onclick=()=>{
        currentPath.push(ch.name);
        if(activeTarget) testClicks++;
        render();
      };
    } else {
      d.onclick=()=>onProductClick(ch.name);
    }
    c.appendChild(d);
  });
}

function goTo(i){currentPath=currentPath.slice(0,i+1);if(activeTarget) testClicks++;render();}
function goBack(){if(currentPath.length){currentPath.pop();if(activeTarget) testClicks++;render();}}
function goHome(){currentPath=[];if(activeTarget) testClicks++;render();}

/* ========= –û–¢–ë–û–† –¢–û–í–ê–†–û–í (–§–ò–ù–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê) ========= */
function collectItems(node,path=[],result=[]){
  const DAYS=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞','–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];

  Object.values(node).forEach(n=>{
    const newPath=[...path,n.name];
    let allow=true;

    // –ó–∞–≤—Ç—Ä–∞–∫–∏/–õ–∞–Ω—á–∏ ‚Üí –¢–û–õ–¨–ö–û –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
    if(newPath[0]==='–ó–∞–≤—Ç—Ä–∞–∫–∏/–õ–∞–Ω—á–∏'){
      const days=newPath.filter(p=>DAYS.includes(p));
      if(!days.includes('–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫')) allow=false;
      if(days.some(d=>d!=='–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫')) allow=false;
    }

    // –î–æ–ø/–ü–æ–∑ ‚Üí –¢–û–õ–¨–ö–û –ö–û–†–ï–ù–¨
    if(newPath[0]==='–î–æ–ø/–ü–æ–∑' && newPath.length!==2){
      allow=false;
    }

    if(n.type==='item' && allow){
      result.push({
        name:n.name,
        steps:newPath.length-1,
        section:newPath[0]
      });
    }

    if(n.children) collectItems(n.children,newPath,result);
  });
  return result;
}

/* ========= –¢–ï–°–¢ ========= */
function startSmartTest(){
  employee=document.getElementById('employeeName').value.trim();
  if(!employee){alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');return;}

  const allItems=collectItems(tree);
  if(allItems.length<5){alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–∑–∏—Ü–∏–π');return;}

  testItems=allItems.sort(()=>0.5-Math.random()).slice(0,5);
  testIndex=0;
  nextTestItem();
}

function nextTestItem(){
  if(testIndex>=testItems.length){
    alert('–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
    activeTarget=null;
    return;
  }

  activeTarget=testItems[testIndex];
  testClicks=0;
  currentPath=[];
  document.getElementById('wrongBox').style.display='none';
  render();

  document.getElementById('testBox').style.display='block';
  document.getElementById('testBox').innerHTML=
    `<b>${employee}</b><br>–ù–∞–π–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä: <b>${activeTarget.name}</b><br>–≠—Ç–∞–ª–æ–Ω: ${activeTarget.steps}`;
}

function onProductClick(name){
  if(!activeTarget) return;

  const success=name===activeTarget.name;
  if(!success) document.getElementById('wrongBox').style.display='block';

  const record={
    date:new Date().toLocaleString(),
    employee,
    product:activeTarget.name,
    section:activeTarget.section,
    expected:activeTarget.steps,
    actual:testClicks,
    delta:testClicks-activeTarget.steps,
    kpiOk:success && testClicks<=activeTarget.steps+1
  };

  testHistory.push(record);
  localStorage.setItem(STORAGE_KEY,JSON.stringify(testHistory));

  testIndex++;
  setTimeout(nextTestItem,700);
}

/* ========= –≠–ö–°–ü–û–†–¢ ========= */
function exportResults(){
  if(!testHistory.length){alert('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞');return;}

  const sheet1=XLSX.utils.json_to_sheet(testHistory.map((r,i)=>({
    '#':i+1,
    –î–∞—Ç–∞:r.date,
    –°–æ—Ç—Ä—É–¥–Ω–∏–∫:r.employee,
    –¢–æ–≤–∞—Ä:r.product,
    –†–∞–∑–¥–µ–ª:r.section,
    –≠—Ç–∞–ª–æ–Ω:r.expected,
    –§–∞–∫—Ç:r.actual,
    –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ:r.delta,
    'KPI OK':r.kpiOk?'–î–∞':'–ù–µ—Ç'
  })));

  const stats={};
  testHistory.forEach(r=>{
    const k=r.section;
    if(!stats[k]) stats[k]={t:0,o:0};
    stats[k].t++; if(r.kpiOk) stats[k].o++;
  });

  const sheet2=XLSX.utils.json_to_sheet(
    Object.entries(stats).map(([k,v])=>({
      –†–∞–∑–¥–µ–ª:k,
      –¢–µ—Å—Ç–æ–≤:v.t,
      'KPI OK':v.o,
      '% KPI OK':Math.round(v.o/v.t*100)
    })).sort((a,b)=>b['% KPI OK']-a['% KPI OK'])
  );

  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,sheet1,'–ò—Å—Ç–æ—Ä–∏—è');
  XLSX.utils.book_append_sheet(wb,sheet2,'–†–µ–π—Ç–∏–Ω–≥');
  XLSX.writeFile(wb,'ux_test_history.xlsx');
}
</script>

</body>
</html>
